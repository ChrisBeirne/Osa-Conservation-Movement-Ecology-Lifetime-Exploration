name: scheduleRenderbook
on:     
  push:
  schedule:     
     - cron: "5 5 * * 1"

# Cancel previous runs if new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  bookdown:
    name: Render-Book
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true  # Faster package installation
      
      - uses: r-lib/actions/setup-pandoc@v2
      
      - name: Install TinyTeX
        uses: r-lib/actions/setup-tinytex@v2
        env:
          TINYTEX_INSTALLER: TinyTeX
      
      # Cache R packages to speed up subsequent runs
      - name: Cache R packages
        uses: actions/cache@v4
        with:
          path: ${{ env.R_LIBS_USER }}
          key: ${{ runner.os }}-r-${{ hashFiles('DESCRIPTION') }}
          restore-keys: |
            ${{ runner.os }}-r-
      
      # Install all packages in one step for efficiency
      - name: Install R packages
        run: |
          Rscript -e 'install.packages(c(
            "rmarkdown", "bookdown", "units", "leaflet", "move", 
            "dplyr", "sf", "viridis", "kableExtra", "lubridate", 
            "plotly", "googledrive", "purrr", "readxl", "geosphere", 
            "foreach", "maptools", "leaflet.extras", "terra", "ggplot2",
            "remotes", "ctmm", "move2"
          ))'
          Rscript -e "install.packages('raster', type='mac.binary')"
      
      - name: Install atlastools
        run: Rscript -e "remotes::install_github('pratikunterwegs/atlastools')"
        env: 
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Render Book
        env: 
          GOOGLE_AUTHENTICATION_CREDENTIALS: ${{ secrets.GOOGLE_AUTHENTICATION_CREDENTIALS }}
          MOVEBANK_USERNAME: ${{ secrets.MOVEBANK_USERNAME }}
          MOVEBANK_PASSWORD: ${{ secrets.MOVEBANK_PASSWORD }}
        run: Rscript -e 'bookdown::render_book("index.Rmd")'
      
      - uses: actions/upload-artifact@v4
        with:
          name: _book
          path: _book/
  
  checkout-and-deploy:
    runs-on: ubuntu-latest
    needs: bookdown
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: _book
          path: _book
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_book
          publish_branch: gh-pages